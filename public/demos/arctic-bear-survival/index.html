<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arctic Bear Survival</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        body {
            font-family: 'Nunito', sans-serif;
            background: #1a2332;
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            touch-action: none;
        }
        
        #gameContainer {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F7FA 100%);
        }

        canvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
            box-shadow: 0 0 50px rgba(0,0,0,0.2);
        }

        /* UI Layer */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .hud-top {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stat-pill {
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            padding: 8px 16px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 2px solid rgba(255,255,255,0.2);
            width: 280px;
        }

        .stat-icon { font-size: 24px; width: 30px; text-align: center; }
        
        .bar-container {
            flex: 1;
            height: 16px;
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .bar-fill::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0.1) 100%);
        }

        .hp-bar { background: linear-gradient(90deg, #ff6b6b, #ff8787); }
        .warmth-bar { background: linear-gradient(90deg, #ff922b, #ffa94d); }
        .hunger-bar { background: linear-gradient(90deg, #51cf66, #69db7c); }

        .inventory {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            font-family: 'Fredoka One', cursive;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .inv-row { display: flex; gap: 15px; justify-content: center; font-size: 18px; }
        .inv-item { display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.05); padding: 5px 10px; border-radius: 10px; }
        
        .crafting-panel {
            margin-top: 5px;
            border-top: 2px dashed #ddd;
            padding-top: 10px;
        }

        .craft-btn {
            background: #eee;
            border: none;
            padding: 8px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'Nunito', sans-serif;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.2s;
            width: 100%;
            margin-bottom: 5px;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: #888;
        }

        .craft-btn.active {
            background: #4dabf7;
            color: white;
            transform: scale(1.02);
            box-shadow: 0 4px 0 #339af0;
        }
        
        .craft-btn.active:active {
            transform: scale(0.98);
            box-shadow: 0 0 0 #339af0;
        }

        .controls-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 30px;
            color: white;
            font-size: 14px;
            text-align: center;
        }

        .key {
            display: inline-block;
            background: white;
            color: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            margin: 0 2px;
            box-shadow: 0 2px 0 #ccc;
        }

        /* Floating Messages */
        .floater {
            position: absolute;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            font-weight: bold;
            font-family: 'Fredoka One', cursive;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-size: 20px;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.2); }
        }

        /* Overlays */
        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            z-index: 100;
            transition: opacity 0.3s;
        }

        .hidden { opacity: 0; pointer-events: none; }

        .card {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: #333;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        h1 { font-family: 'Fredoka One', cursive; color: #2c3e50; font-size: 42px; margin-bottom: 10px; }
        h2 { font-family: 'Fredoka One', cursive; color: #e67700; font-size: 32px; margin-bottom: 20px; }
        p { margin-bottom: 25px; font-size: 18px; line-height: 1.6; color: #666; }

        .btn-primary {
            background: linear-gradient(135deg, #4dabf7 0%, #339af0 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 24px;
            border-radius: 50px;
            font-family: 'Fredoka One', cursive;
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 0 6px 0 #228be6;
        }

        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 0 #228be6; }
        .btn-primary:active { transform: translateY(4px); box-shadow: 0 0 0 #228be6; }

        /* Mobile Controls */
        .touch-controls {
            display: none; /* Hidden by default, shown on touch devices via JS detection could happen but pure CSS media query is safer for now */
        }
        
        @media (hover: none) and (pointer: coarse) {
            .touch-controls {
                display: block;
                position: absolute;
                bottom: 20px;
                width: 100%;
                height: 150px;
                pointer-events: none;
            }
            
            .dpad {
                position: absolute;
                bottom: 20px;
                left: 20px;
                width: 120px;
                height: 120px;
                pointer-events: auto;
            }
            
            .action-btn {
                position: absolute;
                bottom: 30px;
                right: 20px;
                width: 80px;
                height: 80px;
                border-radius: 50%;
                background: rgba(255,255,255,0.3);
                border: 2px solid white;
                color: white;
                font-size: 30px;
                display: flex;
                justify-content: center;
                align-items: center;
                pointer-events: auto;
                backdrop-filter: blur(5px);
            }

            .action-btn:active { background: rgba(255,255,255,0.5); }

            .controls-hint { display: none; } /* Hide keyboard hints on mobile */
        }

        .day-badge {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            color: #333;
            padding: 10px 30px;
            border-radius: 0 0 20px 20px;
            font-family: 'Fredoka One', cursive;
            font-size: 24px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: -20px; /* Tuck it up */
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div class="ui-layer">
            <div class="day-badge">Day <span id="dayVal">1</span></div>

            <div class="hud-top">
                <div class="stat-pill">
                    <div class="stat-icon">‚ù§Ô∏è</div>
                    <div class="bar-container">
                        <div class="bar-fill hp-bar" id="hpBar" style="width: 100%"></div>
                    </div>
                </div>
                <div class="stat-pill">
                    <div class="stat-icon">üî•</div>
                    <div class="bar-container">
                        <div class="bar-fill warmth-bar" id="warmthBar" style="width: 100%"></div>
                    </div>
                </div>
                <div class="stat-pill">
                    <div class="stat-icon">üçñ</div>
                    <div class="bar-container">
                        <div class="bar-fill hunger-bar" id="hungerBar" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <div class="inventory">
                <div class="inv-row">
                    <div class="inv-item">ü™µ <span id="woodVal">0</span></div>
                    <div class="inv-item">üçñ <span id="foodVal">0</span></div>
                    <div class="inv-item">üî© <span id="matVal">0</span></div>
                </div>
                
                <div class="crafting-panel">
                    <button class="craft-btn" id="btnTrap">
                        <span>Food Trap ü™§</span>
                        <small>3ü™µ 2üî©</small>
                    </button>
                    <button class="craft-btn" id="btnBearTrap">
                        <span>Bear Trap ‚öôÔ∏è</span>
                        <small>5ü™µ 5üî©</small>
                    </button>
                    <button class="craft-btn" id="btnEat">
                        <span>Eat Food üçñ</span>
                        <small>Restore HP</small>
                    </button>
                </div>
            </div>

            <div class="controls-hint">
                Use <span class="key">W</span><span class="key">A</span><span class="key">S</span><span class="key">D</span> to move ‚Ä¢ <span class="key">SPACE</span> to interact
            </div>
            
            <div class="touch-controls">
                <div class="dpad" id="virtualDpad"></div> <!-- Placeholder for touch logic -->
                <div class="action-btn" id="virtualBtn">üëã</div>
            </div>
        </div>

        <!-- Start Screen -->
        <div id="startScreen" class="overlay">
            <div class="card">
                <h1>üêª Arctic Survival</h1>
                <p>You are lost in the frozen north!</p>
                <p>Gather wood ü™µ, hunt rabbits üêá, and avoid the grumpy bears üêª.</p>
                <p><strong>Goal:</strong> Survive as many days as you can!</p>
                <button class="btn-primary" id="startBtn">PLAY NOW</button>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverScreen" class="overlay hidden">
            <div class="card">
                <h1>ü•∂ BRRR!</h1>
                <p>The cold got you (or a bear did)!</p>
                <div style="font-size: 24px; margin-bottom: 20px; color: #333;">
                    Days Survived: <strong id="finalDays" style="color: #4dabf7;">0</strong>
                </div>
                <button class="btn-primary" onclick="location.reload()">TRY AGAIN</button>
            </div>
        </div>
    </div>

    <script>
        // --- Game Engine ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Resize canvas to fit window but keep aspect ratio
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // Game State
        const game = {
            running: false,
            day: 1,
            time: 0, // 0 to 24 hours
            player: {
                x: canvas.width / 2,
                y: canvas.height / 2,
                vx: 0, vy: 0,
                speed: 200,
                hp: 100,
                warmth: 100,
                hunger: 100,
                inv: { wood: 0, food: 0, materials: 0, traps: 0, bearTraps: 0 },
                facing: 1, // 1 right, -1 left
                actionCooldown: 0
            },
            entities: [],
            particles: [],
            cam: { x: 0, y: 0 },
            keys: {}
        };

        // Entity Types
        const TYPES = {
            TREE: 'tree',
            RABBIT: 'rabbit',
            BEAR: 'bear',
            SEAL: 'seal',
            WOOD: 'wood_drop',
            FOOD: 'food_drop',
            TRAP: 'trap',
            BEAR_TRAP: 'bear_trap',
            IGLOO: 'igloo',
            FIRE: 'fire'
        };

        // Assets (Emojis are drawn directly)
        
        // --- Input Handling ---
        window.addEventListener('keydown', e => {
            game.keys[e.key.toLowerCase()] = true;
            if (e.code === 'Space') handleAction();
            
            // Hotkeys for crafting
            if (e.key === '1') craft('trap');
            if (e.key === '2') craft('bearTrap');
            if (e.key === 'e') eatFood();
        });
        window.addEventListener('keyup', e => game.keys[e.key.toLowerCase()] = false);

        // UI Buttons
        document.getElementById('startBtn').addEventListener('click', () => {
            document.getElementById('startScreen').classList.add('hidden');
            initGame();
        });

        document.getElementById('btnTrap').addEventListener('click', () => craft('trap'));
        document.getElementById('btnBearTrap').addEventListener('click', () => craft('bearTrap'));
        document.getElementById('btnEat').addEventListener('click', () => eatFood());
        
        const virtualBtn = document.getElementById('virtualBtn');
        virtualBtn.addEventListener('touchstart', (e) => { e.preventDefault(); handleAction(); });
        virtualBtn.addEventListener('mousedown', (e) => { e.preventDefault(); handleAction(); });

        // Virtual D-Pad Logic (Simple Touch Quadrants)
        const dpad = document.getElementById('virtualDpad');
        let touchId = null;
        dpad.addEventListener('touchstart', e => {
            e.preventDefault();
            touchId = e.changedTouches[0].identifier;
            updateTouchMove(e.changedTouches[0]);
        });
        dpad.addEventListener('touchmove', e => {
            e.preventDefault();
            for(let i=0; i<e.changedTouches.length; i++) {
                if(e.changedTouches[i].identifier === touchId) updateTouchMove(e.changedTouches[i]);
            }
        });
        dpad.addEventListener('touchend', e => {
            e.preventDefault();
            game.keys['w'] = game.keys['a'] = game.keys['s'] = game.keys['d'] = false;
        });

        function updateTouchMove(touch) {
            const rect = dpad.getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;
            const dx = touch.clientX - cx;
            const dy = touch.clientY - cy;
            
            game.keys['w'] = dy < -20;
            game.keys['s'] = dy > 20;
            game.keys['a'] = dx < -20;
            game.keys['d'] = dx > 20;
        }

        // --- Core Logic ---
        function initGame() {
            game.running = true;
            game.entities = [];
            game.particles = [];
            game.day = 1;
            game.time = 0;
            
            // Generate World
            // Trees
            for(let i=0; i<30; i++) {
                game.entities.push({
                    type: TYPES.TREE,
                    x: Math.random() * 2000 - 1000,
                    y: Math.random() * 2000 - 1000,
                    hp: 3,
                    scale: 0.8 + Math.random() * 0.4
                });
            }
            
            // Rabbits
            for(let i=0; i<15; i++) {
                spawnRabbit();
            }

            // Bears
            for(let i=0; i<3; i++) {
                spawnBear();
            }

            // Starting Igloo (Ruined) - acts as base
            game.entities.push({
                type: TYPES.IGLOO,
                x: 0,
                y: 0,
                built: false,
                progress: 0
            });

            gameLoop();
        }

        function spawnRabbit() {
            game.entities.push({
                type: TYPES.RABBIT,
                x: Math.random() * 2000 - 1000,
                y: Math.random() * 2000 - 1000,
                vx: 0, vy: 0,
                timer: 0,
                state: 'idle'
            });
        }

        function spawnBear() {
            const angle = Math.random() * Math.PI * 2;
            const dist = 800 + Math.random() * 400;
            game.entities.push({
                type: TYPES.BEAR,
                x: Math.cos(angle) * dist,
                y: Math.sin(angle) * dist,
                vx: 0, vy: 0,
                state: 'wandering',
                timer: 0,
                hp: 5
            });
        }

        function spawnParticle(x, y, emoji, count=1) {
            for(let i=0; i<count; i++) {
                game.particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 200,
                    vy: (Math.random() - 0.5) * 200 - 100,
                    emoji,
                    life: 1.0,
                    scale: 0.5 + Math.random() * 0.5
                });
            }
        }

        function showFloatText(x, y, text, color='white') {
            const el = document.createElement('div');
            el.className = 'floater';
            el.textContent = text;
            el.style.left = (canvas.width/2 + (x - game.player.x)) + 'px';
            el.style.top = (canvas.height/2 + (y - game.player.y)) + 'px';
            el.style.color = color;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function handleAction() {
            if (!game.running) return;
            const p = game.player;
            
            // Check interaction with nearest entity
            const nearest = game.entities.find(e => {
                const d = Math.hypot(e.x - p.x, e.y - p.y);
                return d < 60;
            });

            if (nearest) {
                if (nearest.type === TYPES.TREE) {
                    nearest.hp--;
                    spawnParticle(nearest.x, nearest.y - 20, 'üçÇ', 3);
                    if (nearest.hp <= 0) {
                        // Drop wood
                        game.entities.push({ type: TYPES.WOOD, x: nearest.x, y: nearest.y });
                        // Respawn tree elsewhere
                        nearest.x = Math.random() * 2000 - 1000;
                        nearest.y = Math.random() * 2000 - 1000;
                        nearest.hp = 3;
                        showFloatText(p.x, p.y - 50, "+ Wood", "#deb887");
                    }
                } else if (nearest.type === TYPES.WOOD) {
                    p.inv.wood++;
                    p.inv.materials += Math.random() > 0.5 ? 1 : 0;
                    showFloatText(p.x, p.y - 50, "+1 Wood", "#deb887");
                    game.entities = game.entities.filter(e => e !== nearest);
                    spawnParticle(p.x, p.y, '‚ú®', 5);
                } else if (nearest.type === TYPES.FOOD) {
                    p.inv.food++;
                    showFloatText(p.x, p.y - 50, "+1 Food", "#ff6b6b");
                    game.entities = game.entities.filter(e => e !== nearest);
                    spawnParticle(p.x, p.y, '‚ú®', 5);
                } else if (nearest.type === TYPES.IGLOO && !nearest.built) {
                    if (p.inv.wood >= 1) {
                        p.inv.wood--;
                        nearest.progress += 10;
                        spawnParticle(nearest.x, nearest.y, '‚ùÑÔ∏è', 5);
                        if (nearest.progress >= 100) {
                            nearest.built = true;
                            showFloatText(nearest.x, nearest.y, "Home Sweet Home!", "#4dabf7");
                        }
                    } else {
                        showFloatText(nearest.x, nearest.y, "Need Wood!", "red");
                    }
                }
            }
        }

        function craft(item) {
            const p = game.player;
            if (item === 'trap') {
                if (p.inv.wood >= 3 && p.inv.materials >= 2) {
                    p.inv.wood -= 3;
                    p.inv.materials -= 2;
                    game.entities.push({ type: TYPES.TRAP, x: p.x, y: p.y, caught: false });
                    showFloatText(p.x, p.y, "Trap Set!", "#51cf66");
                } else showFloatText(p.x, p.y, "Need 3ü™µ 2üî©", "red");
            }
            if (item === 'bearTrap') {
                if (p.inv.wood >= 5 && p.inv.materials >= 5) {
                    p.inv.wood -= 5;
                    p.inv.materials -= 5;
                    game.entities.push({ type: TYPES.BEAR_TRAP, x: p.x, y: p.y, caught: false });
                    showFloatText(p.x, p.y, "Big Trap Set!", "#ff922b");
                } else showFloatText(p.x, p.y, "Need 5ü™µ 5üî©", "red");
            }
        }

        function eatFood() {
            const p = game.player;
            if (p.inv.food > 0) {
                p.inv.food--;
                p.hp = Math.min(100, p.hp + 20);
                p.hunger = Math.min(100, p.hunger + 40);
                spawnParticle(p.x, p.y, '‚ù§Ô∏è', 5);
                showFloatText(p.x, p.y, "Yum!", "#51cf66");
            } else {
                showFloatText(p.x, p.y, "No Food!", "red");
            }
        }

        function update(dt) {
            if (!game.running) return;
            
            const p = game.player;
            
            // Controls
            let dx = 0, dy = 0;
            if (game.keys['w'] || game.keys['arrowup']) dy = -1;
            if (game.keys['s'] || game.keys['arrowdown']) dy = 1;
            if (game.keys['a'] || game.keys['arrowleft']) { dx = -1; p.facing = -1; }
            if (game.keys['d'] || game.keys['arrowright']) { dx = 1; p.facing = 1; }
            
            if (dx !== 0 || dy !== 0) {
                const len = Math.hypot(dx, dy);
                dx /= len; dy /= len;
                p.x += dx * p.speed * dt;
                p.y += dy * p.speed * dt;
                
                // Footprints (particles)
                if (Math.random() < 0.1) {
                    game.particles.push({
                        x: p.x, y: p.y + 10,
                        vx: 0, vy: 0,
                        emoji: 'üë£',
                        life: 3.0,
                        scale: 0.3
                    });
                }
            }

            // Survival Drain
            p.hunger -= dt * 1.5;
            p.warmth -= dt * 1.0;
            
            // Time Cycle
            game.time += dt * 0.5; // 1 hour per 2 real seconds
            if (game.time >= 24) {
                game.time = 0;
                game.day++;
                document.getElementById('dayVal').textContent = game.day;
                showFloatText(p.x, p.y - 100, `Day ${game.day}`, '#4dabf7');
                
                // Respawn Trees/Rabbits
                if (game.entities.filter(e => e.type === TYPES.TREE).length < 15) {
                    for(let i=0; i<5; i++) {
                        game.entities.push({
                            type: TYPES.TREE,
                            x: Math.random() * 2000 - 1000,
                            y: Math.random() * 2000 - 1000,
                            hp: 3,
                            scale: 0.8 + Math.random() * 0.4
                        });
                    }
                }
            }
            
            // Near Igloo Warmth
            const igloo = game.entities.find(e => e.type === TYPES.IGLOO && e.built);
            if (igloo && Math.hypot(p.x - igloo.x, p.y - igloo.y) < 80) {
                p.warmth = Math.min(100, p.warmth + dt * 10);
            }

            if (p.hunger <= 0 || p.warmth <= 0) p.hp -= dt * 2;
            
            if (p.hp <= 0) {
                game.running = false;
                document.getElementById('finalDays').textContent = game.day;
                document.getElementById('gameOverScreen').classList.remove('hidden');
            }

            // Update UI
            document.getElementById('hpBar').style.width = Math.max(0, p.hp) + '%';
            document.getElementById('warmthBar').style.width = Math.max(0, p.warmth) + '%';
            document.getElementById('hungerBar').style.width = Math.max(0, p.hunger) + '%';
            
            document.getElementById('woodVal').textContent = p.inv.wood;
            document.getElementById('foodVal').textContent = p.inv.food;
            document.getElementById('matVal').textContent = p.inv.materials;
            
            // Enable/Disable craft buttons
            document.getElementById('btnTrap').classList.toggle('active', p.inv.wood >= 3 && p.inv.materials >= 2);
            document.getElementById('btnBearTrap').classList.toggle('active', p.inv.wood >= 5 && p.inv.materials >= 5);
            document.getElementById('btnEat').classList.toggle('active', p.inv.food > 0);

            // Entities Update
            game.entities.forEach(e => {
                if (e.type === TYPES.RABBIT) {
                    // Rabbit logic
                    e.timer -= dt;
                    if (e.timer <= 0) {
                        e.timer = Math.random() * 2 + 1;
                        e.vx = (Math.random() - 0.5) * 100;
                        e.vy = (Math.random() - 0.5) * 100;
                    }
                    e.x += e.vx * dt;
                    e.y += e.vy * dt;
                    
                    // Check Trap
                    const trap = game.entities.find(t => t.type === TYPES.TRAP && !t.caught && Math.hypot(t.x - e.x, t.y - e.y) < 30);
                    if (trap) {
                        trap.caught = true;
                        // Turn rabbit into food drop
                        game.entities.push({ type: TYPES.FOOD, x: e.x, y: e.y });
                        e.dead = true;
                        showFloatText(e.x, e.y, "Caught!", "#51cf66");
                    }
                } else if (e.type === TYPES.BEAR) {
                    // Bear logic
                    const distToPlayer = Math.hypot(p.x - e.x, p.y - e.y);
                    
                    if (distToPlayer < 300) {
                        e.state = 'chasing';
                        const angle = Math.atan2(p.y - e.y, p.x - e.x);
                        e.x += Math.cos(angle) * 110 * dt; // Bear speed
                        e.y += Math.sin(angle) * 110 * dt;
                        
                        if (distToPlayer < 40) {
                            p.hp -= dt * 30;
                            p.x += Math.cos(angle) * 200 * dt; // Knockback
                            p.y += Math.sin(angle) * 200 * dt;
                            spawnParticle(p.x, p.y, 'üí•', 1);
                        }
                    } else {
                        e.state = 'wandering';
                    }
                    
                    // Check Bear Trap
                    const trap = game.entities.find(t => t.type === TYPES.BEAR_TRAP && !t.caught && Math.hypot(t.x - e.x, t.y - e.y) < 40);
                    if (trap) {
                        trap.caught = true; // One use
                        e.hp--;
                        showFloatText(e.x, e.y, "Bear Snared!", "#ff922b");
                        spawnParticle(e.x, e.y, 'üí¢', 5);
                        // Teleport bear away if hurt enough? Or just slow it?
                        if (e.hp <= 0) {
                            e.dead = true;
                            spawnParticle(e.x, e.y, 'ü•©', 5);
                            game.entities.push({ type: TYPES.FOOD, x: e.x, y: e.y });
                            game.entities.push({ type: TYPES.FOOD, x: e.x+10, y: e.y });
                        } else {
                            e.x += 200; // Flee
                        }
                    }
                }
            });
            
            // Cleanup dead entities
            game.entities = game.entities.filter(e => !e.dead);

            // Particles
            for(let i=game.particles.length-1; i>=0; i--) {
                const part = game.particles[i];
                part.x += part.vx * dt;
                part.y += part.vy * dt;
                part.life -= dt;
                if (part.life <= 0) game.particles.splice(i, 1);
            }
        }

        function drawEmoji(emoji, x, y, size, scale=1, align='center') {
            ctx.font = `${size * scale}px 'Nunito', sans-serif`;
            ctx.textAlign = align;
            ctx.textBaseline = 'middle';
            ctx.fillText(emoji, x - game.cam.x + canvas.width/2, y - game.cam.y + canvas.height/2);
        }

        function render() {
            // Camera Follow
            const p = game.player;
            // Smooth Lerp
            game.cam.x += (p.x - game.cam.x) * 0.1;
            game.cam.y += (p.y - game.cam.y) * 0.1;

            // Background
            ctx.fillStyle = '#e8f4f8';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw Grid/Snow Floor
            const gridSize = 100;
            const offsetX = Math.floor((game.cam.x - canvas.width/2) / gridSize) * gridSize;
            const offsetY = Math.floor((game.cam.y - canvas.height/2) / gridSize) * gridSize;
            
            ctx.fillStyle = '#dbeff7';
            for (let x = offsetX - gridSize; x < offsetX + canvas.width + gridSize; x += gridSize) {
                for (let y = offsetY - gridSize; y < offsetY + canvas.height + gridSize; y += gridSize) {
                    if ((Math.floor(x/gridSize) + Math.floor(y/gridSize)) % 2 === 0) {
                        // relative coordinates for camera
                        const drawX = x - game.cam.x + canvas.width/2;
                        const drawY = y - game.cam.y + canvas.height/2;
                        ctx.beginPath();
                        ctx.arc(drawX, drawY, 2, 0, Math.PI*2);
                        ctx.fill();
                    }
                }
            }

            // Shadows
            game.entities.forEach(e => {
                const screenX = e.x - game.cam.x + canvas.width/2;
                const screenY = e.y - game.cam.y + canvas.height/2;
                ctx.fillStyle = 'rgba(0,0,0,0.1)';
                ctx.beginPath();
                ctx.ellipse(screenX, screenY + 15, 20, 8, 0, 0, Math.PI*2);
                ctx.fill();
            });

            // Entities sorted by Y for depth
            const renderList = [...game.entities, { ...p, type: 'player' }];
            renderList.sort((a, b) => a.y - b.y);

            renderList.forEach(e => {
                const screenX = e.x - game.cam.x + canvas.width/2;
                const screenY = e.y - game.cam.y + canvas.height/2;
                
                // Cull off-screen
                if (screenX < -100 || screenX > canvas.width + 100 || screenY < -100 || screenY > canvas.height + 100) return;

                if (e.type === TYPES.TREE) {
                    drawEmoji('üå≤', e.x, e.y - 20, 60, e.scale);
                    if (e.hp < 3) {
                         ctx.fillStyle = 'white';
                         ctx.font = '12px sans-serif';
                         ctx.fillText(`${e.hp} HP`, screenX, screenY - 60);
                    }
                }
                else if (e.type === TYPES.RABBIT) {
                    ctx.save();
                    if (e.vx < 0) ctx.scale(-1, 1);
                    drawEmoji('üêá', e.vx < 0 ? -e.x : e.x, e.y, 30);
                    ctx.restore();
                }
                else if (e.type === TYPES.BEAR) {
                    const bounce = Math.sin(Date.now() / 200) * 5;
                    drawEmoji(e.state === 'chasing' ? 'üò°' : 'üêª', e.x, e.y + bounce - 10, 50);
                    if (e.state === 'chasing') {
                        drawEmoji('üí¢', e.x + 20, e.y - 40, 20);
                    }
                }
                else if (e.type === TYPES.WOOD) drawEmoji('ü™µ', e.x, e.y, 30);
                else if (e.type === TYPES.FOOD) drawEmoji('üçñ', e.x, e.y, 30);
                else if (e.type === TYPES.TRAP) drawEmoji(e.caught ? 'üîí' : 'ü™§', e.x, e.y, 30);
                else if (e.type === TYPES.BEAR_TRAP) drawEmoji(e.caught ? 'üîí' : '‚öôÔ∏è', e.x, e.y, 40);
                else if (e.type === TYPES.IGLOO) {
                    if (e.built) drawEmoji('üõñ', e.x, e.y - 10, 80);
                    else {
                        ctx.globalAlpha = 0.5;
                        drawEmoji('üõñ', e.x, e.y - 10, 80);
                        ctx.globalAlpha = 1;
                        ctx.fillStyle = 'black';
                        ctx.font = '14px Arial';
                        ctx.fillText(`${e.progress}%`, screenX, screenY - 50);
                    }
                }
                else if (e.type === 'player') {
                    const bounce = Math.abs(Math.sin(Date.now() / 150)) * 5;
                    const yOff = (game.keys['w'] || game.keys['a'] || game.keys['s'] || game.keys['d']) ? bounce : 0;
                    
                    // Flip logic
                    ctx.save();
                    ctx.translate(screenX, screenY);
                    if (p.facing === -1) ctx.scale(-1, 1);
                    
                    ctx.font = '45px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(p.hp < 30 ? 'ü•∂' : 'üòÉ', 0, yOff - 10);
                    
                    // Coat
                    if (p.warmth > 80) ctx.fillText('üß£', 0, yOff + 15);
                    else ctx.fillText('üëï', 0, yOff + 15);

                    ctx.restore();
                }
            });

            // Darkness Overlay (Night)
            const hour = game.time;
            let darkness = 0;
            if (hour > 18 || hour < 6) {
                // Night: 18->24 (0.4), 0->6 (0.4)
                darkness = 0.4;
                if (hour > 18) darkness = ((hour - 18) / 6) * 0.4;
                if (hour < 6) darkness = ((6 - hour) / 6) * 0.4;
            }
            
            if (darkness > 0) {
                ctx.fillStyle = `rgba(0, 10, 40, ${darkness})`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw Fire Glow if night
                const fire = game.entities.find(e => e.type === TYPES.FIRE);
                // (Assuming we add fire logic later, but igloo has light)
                const igloo = game.entities.find(e => e.type === TYPES.IGLOO && e.built);
                if (igloo) {
                    const ix = igloo.x - game.cam.x + canvas.width/2;
                    const iy = igloo.y - game.cam.y + canvas.height/2;
                    const grad = ctx.createRadialGradient(ix, iy, 10, ix, iy, 150);
                    grad.addColorStop(0, 'rgba(255, 200, 100, 0.3)');
                    grad.addColorStop(1, 'rgba(0,0,0,0)');
                    ctx.fillStyle = grad;
                    ctx.beginPath();
                    ctx.arc(ix, iy, 150, 0, Math.PI*2);
                    ctx.fill();
                }
            }

            // Particles
            game.particles.forEach(p => {
                ctx.globalAlpha = p.life;
                drawEmoji(p.emoji, p.x, p.y, 20 * p.scale);
                ctx.globalAlpha = 1;
            });
        }

        let lastTime = 0;
        function loop(timestamp) {
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;
            update(dt || 0.016);
            render();
            requestAnimationFrame(loop);
        }

        requestAnimationFrame(loop);
        
        // Start loop (game running check inside update)
        function gameLoop() {
             // just a placeholder if needed, but main loop handles it
        }
    </script>
</body>
</html>